#
# GitHub actions to build python and test the result.
#
# Available VMs. Don't use `-latest` as we want to pin an OS version.
# https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners
#
name: GitHub-CI

# Only run on pull requests and only for Python files.
on:
  push:
    branches: [ master ]
    paths:
    - '**.py'
  pull_request:
    branches: [ master ]
    paths:
    - '**.py'

jobs:

  ubuntu-20-04:
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Make sure we don't have multiple job
    - uses: chevah/auto-cancel-redundant-job@v1

    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
      with:
        fetch-depth: 2

    - name: Fail on skip ci
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-ci'

    - name: Fail on skip gha
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-gha'

    - name: Build
      run: |
        ./chevah_build build

    - name: Test Python
      run: ./chevah_build test

    - name: Test Compat
      run: ./chevah_build test_compat

  macos-10-15:
    runs-on: macos-10.15
    timeout-minutes: 15
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Make sure we don't have multiple job
    - uses: chevah/auto-cancel-redundant-job@v1

    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
      with:
        fetch-depth: 2

    - name: Fail on skip ci
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-ci'

    - name: Fail on skip gha
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-gha'

    - name: Build
      run: |
        ./chevah_build build

    - name: Test Python
      run: ./chevah_build test

    - name: Test Compat
      run: ./chevah_build test_compat
