#!/bin/bash
#
# Chevah Build Script for libffi.
#
# For now it is supported only on AIX and Solaris.
#
# Import shared code.
. ./functions.sh


chevahbs_configure() {
    # We want only static build so that we don't have to mess with LIBPATH.
    execute ./configure --prefix="" --disable-shared --enable-static
}


chevahbs_compile() {
    execute $MAKE
}


chevahbs_install() {
    install_folder=$1

    if [ x${ARCH##ppc} != x"$ARCH" ]; then
        # libffi installs its headers in $PREFIX/lib/libffi-$VERSION/include,
        # instead of $PREFIX/include, so we copy them manually in AIX.
        local temp_folder=$INSTALL_FOLDER/tmp/libffi
        execute mkdir -p $temp_folder

        if [ $OS = 'aix53' ]; then
            execute cp powerpc-ibm-aix5.3.0.0/.libs/* $temp_folder
            execute cp powerpc-ibm-aix5.3.0.0/include/*.h $temp_folder
        elif [ $OS = 'aix71' ]; then
            execute cp powerpc-ibm-aix7.1.0.0/.libs/* $temp_folder
            execute cp powerpc-ibm-aix7.1.0.0/include/*.h $temp_folder
        fi
    fi
}


select_chevahbs_command $@
