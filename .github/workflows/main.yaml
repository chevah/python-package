#
# GitHub actions to build python and test the result.
#
# Available VMs. Don't use `-latest` as we want to pin an OS version.
# https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners
#
name: GitHub-CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]


jobs:

  ubuntu-20-04:
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04
    timeout-minutes: 20
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Make sure we don't have multiple job
    - uses: chevah/auto-cancel-redundant-job@v1

    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
      with:
        fetch-depth: 2

    - name: Fail on skip ci
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-ci'

    - name: Fail on skip gha
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-gha'

    - name: Deps
      run: |
        sudo apt-get install libncurses5-dev

    - name: Create build env
      run: |
        ./brink.sh detect_os

    - name: Build Python
      run: |
        ./chevah_build build

    - name: Test Python
      run: ./chevah_build test

    - name: Test Compat
      run: ./chevah_build test_compat


  macos-10-15:
    runs-on: macos-10.15
    timeout-minutes: 50
    steps:
    - uses: chevah/auto-cancel-redundant-job@v1
    - uses: actions/checkout@v2
      with:
        fetch-depth: 2

    - name: Fail on skip ci
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-ci'

    - name: Fail on skip gha
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-gha'

    - name: Create build env
      run: |
        ./brink.sh detect_os
        # There are many packages depending on readline.
        brew readline uninstall --force

    - name: Build Python
      run: |
        ./chevah_build build

    - name: Test Python
      run: ./chevah_build test

    - name: Test Compat
      run: ./chevah_build test_compat


  windows-2019:
    runs-on: windows-2019
    timeout-minutes: 50
    steps:
    - uses: chevah/auto-cancel-redundant-job@v1
    - uses: actions/checkout@v2
      with:
        fetch-depth: 2

    - name: Fail on skip ci
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-ci'

    - name: Fail on skip gha
      run: git log -1 --pretty=format:"%s" ${{ toJSON(github.event.after) }} | grep -v 'skip-gha'

    - name: Create build env
      run: |
        sh ./brink.sh detect_os

    - name: Build Python
      run: |
        sh ./chevah_build build

    - name: Test Python
      run: sh ./chevah_build test

    - name: Test Compat
      run: sh ./chevah_build test_compat
